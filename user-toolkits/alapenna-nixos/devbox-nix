#!/usr/bin/env zsh
# devbox-nix - NixOS VM lifecycle manager for alapenna-nixos toolkit
#
# Install:
#   cp devbox-nix ~/.local/bin/
#   chmod +x ~/.local/bin/devbox-nix
#
# Usage:
#   devbox-nix          # Enter the VM (creates if needed)
#   devbox-nix stop     # Stop the VM
#   devbox-nix destroy  # Remove VM completely
#   devbox-nix status   # Show VM status
#   devbox-nix rebuild  # Rebuild NixOS configuration
#   devbox-nix rollback # Rollback to previous generation

set -e

NAME="devbox-nix"

# Find configuration.nix - check multiple locations
find_config() {
  # 1. Environment variable
  if [[ -n "$DEVBOX_NIX_CONFIG" && -f "$DEVBOX_NIX_CONFIG" ]]; then
    echo "$DEVBOX_NIX_CONFIG"
    return
  fi
  # 2. User config directory
  if [[ -f "$HOME/.config/devbox-nix/configuration.nix" ]]; then
    echo "$HOME/.config/devbox-nix/configuration.nix"
    return
  fi
  # 3. Script's directory (works when not installed to PATH)
  local script_dir="$(dirname "$0")"
  if [[ -f "$script_dir/configuration.nix" ]]; then
    echo "$script_dir/configuration.nix"
    return
  fi
  # 4. Current directory
  if [[ -f "./configuration.nix" ]]; then
    echo "./configuration.nix"
    return
  fi
  # Not found
  echo ""
}

CONFIG_FILE="$(find_config)"

cmd_enter() {
  # Check if OrbStack is running
  if ! command -v orb &>/dev/null; then
    echo "OrbStack CLI not found. Install OrbStack first."
    exit 1
  fi

  # Create VM if it doesn't exist
  if ! orb list 2>/dev/null | grep -q "^$NAME"; then
    echo "Creating NixOS VM..."
    orb create nixos "$NAME"

    # Wait for VM to be ready
    echo "Waiting for VM to start..."
    sleep 3

    # Copy and apply configuration
    if [[ -n "$CONFIG_FILE" ]]; then
      echo "Copying NixOS configuration from $CONFIG_FILE..."
      orb push -m "$NAME" "$CONFIG_FILE" /tmp/configuration.nix
      orb run -m "$NAME" sudo cp /tmp/configuration.nix /etc/nixos/configuration.nix

      echo "Applying initial configuration (this may take a few minutes)..."
      orb run -m "$NAME" sudo nixos-rebuild switch

      echo ""
      echo "VM created. Run these commands inside to complete setup:"
      echo "  1. gh auth login"
      echo "  2. claude (authenticate)"
      echo ""
    else
      echo ""
      echo "WARNING: configuration.nix not found. VM created with default NixOS config."
      echo "To apply your config, either:"
      echo "  - Set DEVBOX_NIX_CONFIG=/path/to/configuration.nix"
      echo "  - Copy config to ~/.config/devbox-nix/configuration.nix"
      echo "  - Run devbox-nix from the directory containing configuration.nix"
      echo "Then run: devbox-nix rebuild"
      echo ""
    fi
  fi

  # Start VM if stopped
  if ! orb list 2>/dev/null | grep "$NAME" | grep -q "running"; then
    echo "Starting VM..."
    orb start "$NAME"
    sleep 2
  fi

  # Enter the VM
  exec orb -m "$NAME"
}

cmd_stop() {
  if orb list 2>/dev/null | grep "$NAME" | grep -q "running"; then
    echo "Stopping VM..."
    orb stop "$NAME"
  else
    echo "VM not running."
  fi
}

cmd_destroy() {
  if orb list 2>/dev/null | grep -q "^$NAME"; then
    echo -n "This will delete the VM and all data. Continue? [y/N] "
    read confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
      echo "Removing VM..."
      orb delete "$NAME" --force
      echo "VM removed."
    else
      echo "Cancelled."
    fi
  else
    echo "VM does not exist."
  fi
}

cmd_status() {
  if ! command -v orb &>/dev/null; then
    echo "OrbStack: not installed"
    return
  fi

  if orb list 2>/dev/null | grep "$NAME" | grep -q "running"; then
    echo "VM: running"

    # Show NixOS generation info
    echo ""
    echo "NixOS generations:"
    orb run -m "$NAME" sudo nix-env --list-generations -p /nix/var/nix/profiles/system 2>/dev/null | tail -5
  elif orb list 2>/dev/null | grep -q "^$NAME"; then
    echo "VM: stopped"
  else
    echo "VM: not created"
  fi
}

cmd_rebuild() {
  if ! orb list 2>/dev/null | grep "$NAME" | grep -q "running"; then
    echo "VM not running. Start it first with: devbox-nix"
    exit 1
  fi

  # Copy latest configuration
  if [[ -n "$CONFIG_FILE" ]]; then
    echo "Copying updated configuration from $CONFIG_FILE..."
    orb push -m "$NAME" "$CONFIG_FILE" /tmp/configuration.nix
    orb run -m "$NAME" sudo cp /tmp/configuration.nix /etc/nixos/configuration.nix
  else
    echo "WARNING: configuration.nix not found. Rebuilding with existing config in VM."
  fi

  echo "Rebuilding NixOS..."
  orb run -m "$NAME" sudo nixos-rebuild switch
  echo "Done. New generation created."
}

cmd_rollback() {
  if ! orb list 2>/dev/null | grep "$NAME" | grep -q "running"; then
    echo "VM not running. Start it first with: devbox-nix"
    exit 1
  fi

  echo "Rolling back to previous generation..."
  orb run -m "$NAME" sudo nixos-rebuild switch --rollback
  echo "Done. Rolled back to previous generation."
}

cmd_help() {
  echo "devbox-nix - NixOS VM lifecycle manager"
  echo ""
  echo "Usage: devbox-nix [command]"
  echo ""
  echo "Commands:"
  echo "  (none)    Enter the VM (creates/starts if needed)"
  echo "  stop      Stop the VM"
  echo "  destroy   Remove VM completely"
  echo "  status    Show VM status and generations"
  echo "  rebuild   Apply configuration.nix changes"
  echo "  rollback  Rollback to previous NixOS generation"
  echo "  help      Show this help"
}

case "${1:-}" in
  ""|enter)
    cmd_enter
    ;;
  stop)
    cmd_stop
    ;;
  destroy)
    cmd_destroy
    ;;
  status)
    cmd_status
    ;;
  rebuild)
    cmd_rebuild
    ;;
  rollback)
    cmd_rollback
    ;;
  help|--help|-h)
    cmd_help
    ;;
  *)
    echo "Unknown command: $1"
    cmd_help
    exit 1
    ;;
esac
