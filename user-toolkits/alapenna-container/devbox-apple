#!/usr/bin/env zsh
# devbox-apple - Container lifecycle manager using Apple container CLI
#
# Requires: macOS 26+ with Apple container CLI
#
# Install:
#   cp devbox-apple ~/.local/bin/
#   chmod +x ~/.local/bin/devbox-apple
#
# Usage:
#   devbox-apple          # Enter the container (creates/starts if needed)
#   devbox-apple stop     # Stop the container
#   devbox-apple destroy  # Remove container
#   devbox-apple status   # Show container status
#   devbox-apple build    # Build the image
#   devbox-apple logs     # Show container logs

set -e

NAME="devbox-apple"
IMAGE="devbox-apple:latest"

# Paths (adjust to your setup)
WORKSPACE_DIR="$HOME/workspaces/toolkit-workspace"
SHARE_TMP="$HOME/tmp/dev-toolkit"

# Source directories for initial copy (not mounted)
SSH_DIR="$HOME/.ssh"
GNUPG_DIR="$HOME/.gnupg"

# Builder configuration
BUILDER_CPUS=8
BUILDER_MEMORY="8g"

check_container_cli() {
  if ! command -v container &>/dev/null; then
    echo "Apple container CLI not found."
    echo "Requires macOS 26+ with container CLI installed."
    echo "See: https://github.com/apple/container"
    exit 1
  fi
}

# Copy SSH and GPG keys into container (one-time setup)
setup_credentials() {
  echo "Copying SSH keys..."
  # Create directories
  container exec "$NAME" mkdir -p /root/.ssh /root/.gnupg

  # Copy SSH files (if they exist)
  local ssh_files=("$SSH_DIR"/*)
  if [[ -d "$SSH_DIR" ]] && [[ -e "${ssh_files[0]}" ]]; then
    for f in "${ssh_files[@]}"; do
      [[ -f "$f" ]] && cat "$f" | container exec -i "$NAME" tee "/root/.ssh/$(basename "$f")" > /dev/null
    done
    container exec "$NAME" chmod 700 /root/.ssh
    container exec "$NAME" chmod 600 /root/.ssh/* 2>/dev/null || true
  else
    echo "  (no SSH keys found, skipping)"
  fi

  # Copy GPG files (if they exist)
  local gpg_files=("$GNUPG_DIR"/*)
  if [[ -d "$GNUPG_DIR" ]] && [[ -e "${gpg_files[0]}" ]]; then
    echo "Copying GPG keys..."
    for f in "${gpg_files[@]}"; do
      [[ -f "$f" ]] && cat "$f" | container exec -i "$NAME" tee "/root/.gnupg/$(basename "$f")" > /dev/null
    done
    container exec "$NAME" chmod 700 /root/.gnupg
    container exec "$NAME" chmod 600 /root/.gnupg/* 2>/dev/null || true
  else
    echo "  (no GPG keys found, skipping)"
  fi

  echo "Credentials setup complete."
}

cmd_enter() {
  check_container_cli

  # Check if container exists and is running
  if container list 2>/dev/null | grep -q "^$NAME"; then
    # Container exists, exec into it
    exec container exec -ti "$NAME" /bin/zsh -l
  fi

  # Container doesn't exist, create and start it
  echo "Creating container..."

  # Ensure directories exist
  mkdir -p "$WORKSPACE_DIR" "$SHARE_TMP"

  # Build volume arguments
  # Note: Single file mounting support merged (https://github.com/apple/containerization/pull/487)
  # but not yet released in container CLI. When available (likely 0.9.0+), uncomment below:
  #
  # if [[ -S /var/run/docker.sock ]]; then
  #   echo "✓ Docker socket detected - mounting for Docker CLI access"
  #   VOLUME_ARGS+=(--volume "/var/run/docker.sock:/var/run/docker.sock")
  # fi
  VOLUME_ARGS=(
    --volume "$WORKSPACE_DIR:/workspace"
    --volume "$SHARE_TMP:/share-tmp"
  )

  # Start container in detached mode
  # Note: Apple container uses FIXED allocation per VM (not shared like OrbStack)
  # Default is 1GB RAM / 4 CPUs - too low for dev work, so we override.
  container run \
    --name "$NAME" \
    --detach \
    --memory 8g \
    --cpus 4 \
    --publish 10000-19999:10000-19999 \
    "${VOLUME_ARGS[@]}" \
    --ssh \
    "$IMAGE"

  # Wait for container to be ready
  sleep 2

  # Copy credentials on first creation
  setup_credentials

  # Enter the container
  exec container exec -ti "$NAME" /bin/zsh -l
}

cmd_stop() {
  check_container_cli

  if container list 2>/dev/null | grep -q "^$NAME"; then
    echo "Stopping container..."
    container stop "$NAME"
    echo "Container stopped."
  else
    echo "Container not running."
  fi
}

cmd_destroy() {
  check_container_cli

  if container list --all 2>/dev/null | grep -q "^$NAME"; then
    # Stop first if running (silently)
    if container list 2>/dev/null | grep -q "^$NAME"; then
      echo "Stopping container..."
      container stop "$NAME"
    fi

    echo "Removing container..."
    container delete "$NAME"
    echo "Container removed."
  else
    echo "Container does not exist."
  fi
}

cmd_status() {
  check_container_cli

  echo "Container CLI: installed"
  echo ""

  if container list 2>/dev/null | grep -q "^$NAME"; then
    echo "Container: running"
    container inspect "$NAME" 2>/dev/null | head -20
  elif container list --all 2>/dev/null | grep -q "^$NAME"; then
    echo "Container: stopped"
  else
    echo "Container: not created"
  fi

  echo ""
  echo "Image:"
  container image list 2>/dev/null | grep "$IMAGE" || echo "  (not built)"
}

cmd_build() {
  check_container_cli

  # Parse flags
  local keep_builder=false
  if [[ "$1" == "--keep-builder" ]]; then
    keep_builder=true
  fi

  echo "Building image..."

  # Check current builder status
  local current_builder=$(container builder status 2>/dev/null | grep -E "^buildkit" || echo "")
  if [[ -n "$current_builder" ]]; then
    # Builder exists - use it (respect manual configuration)
    local current_cpus=$(echo "$current_builder" | awk '{print $5}')
    local current_mem_mb=$(echo "$current_builder" | awk '{print $6}')
    local current_mem_gb=$((current_mem_mb / 1024))
    echo "Using existing builder: ${current_cpus} CPUs / ${current_mem_gb}g"

    # Check for mismatch with script defaults
    local target_mem_mb=$((${BUILDER_MEMORY%g} * 1024))
    if [[ "$current_cpus" != "$BUILDER_CPUS" ]] || [[ "$current_mem_mb" != "$target_mem_mb" ]]; then
      echo ""
      echo "⚠️  WARNING: Builder config doesn't match script defaults"
      echo "   Current:  ${current_cpus} CPUs / ${current_mem_gb}g"
      echo "   Default:  ${BUILDER_CPUS} CPUs / ${BUILDER_MEMORY}"
      echo ""
      echo "Build may be slower/faster than expected."
      echo "To use defaults, run: devbox-apple builder-configure"
      echo ""
      read "reply?Continue with current builder? [y/N] "
      echo ""
      if [[ ! $reply =~ ^[Yy]$ ]]; then
        echo "Build cancelled."
        exit 0
      fi
    fi
  else
    # No builder - create with script defaults
    echo "No builder found, creating with defaults: ${BUILDER_CPUS} CPUs / ${BUILDER_MEMORY}"
    container builder start --cpus "$BUILDER_CPUS" --memory "$BUILDER_MEMORY"
    sleep 2
  fi

  echo ""

  # Find the Dockerfile location
  SCRIPT_DIR="$(dirname "$0")"
  if [[ -f "$SCRIPT_DIR/Dockerfile" ]]; then
    BUILD_DIR="$SCRIPT_DIR"
  elif [[ -f "./Dockerfile" ]]; then
    BUILD_DIR="."
  else
    echo "Dockerfile not found. Run from the toolkit directory."
    exit 1
  fi

  # Build the image
  container build --tag "$IMAGE" "$BUILD_DIR"
  echo ""
  echo "Image built: $IMAGE"

  # Auto-remove builder unless --keep-builder flag
  if [[ "$keep_builder" == false ]]; then
    echo ""
    echo "Removing builder to free resources (${BUILDER_CPUS} CPUs / ${BUILDER_MEMORY})..."
    echo "(Use --keep-builder flag to keep builder for faster subsequent builds)"
    container builder delete buildkit 2>/dev/null || true
  fi
}

cmd_rebuild() {
  check_container_cli

  echo "Rebuilding container (destroy + build)..."
  echo ""

  # Destroy existing container (auto-stops if needed)
  cmd_destroy
  echo ""

  # Build new image (pass through any flags like --keep-builder)
  cmd_build "$@"
}

cmd_logs() {
  check_container_cli

  if container list --all 2>/dev/null | grep -q "^$NAME"; then
    container logs "$NAME"
  else
    echo "Container does not exist."
  fi
}

cmd_builder_configure() {
  check_container_cli

  local cpus="${1:-$BUILDER_CPUS}"
  local memory="${2:-$BUILDER_MEMORY}"

  echo "Configuring builder: ${cpus} CPUs / ${memory}"
  echo ""

  # Stop and remove existing builder
  if container builder status 2>/dev/null | grep -q "^buildkit"; then
    echo "Removing existing builder..."
    container builder delete
    echo ""
  fi

  # Start with new configuration
  echo "Starting builder with ${cpus} CPUs / ${memory}..."
  container builder start --cpus "$cpus" --memory "$memory"

  echo ""
  echo "Builder configured successfully."
  echo ""
  echo "To make this permanent, edit the script and set:"
  echo "  BUILDER_CPUS=${cpus}"
  echo "  BUILDER_MEMORY=\"${memory}\""
}

cmd_help() {
  echo "devbox-apple - Container lifecycle manager (Apple container)"
  echo ""
  echo "Usage: devbox-apple [command] [options]"
  echo ""
  echo "Commands:"
  echo "  (none)              Enter the container (creates if needed)"
  echo "  stop                Stop the container"
  echo "  destroy             Remove the container"
  echo "  status              Show container and image status"
  echo "  build               Build the container image"
  echo "  rebuild             Destroy container and rebuild image"
  echo "  logs                Show container logs"
  echo "  builder-configure   Configure builder resources (cpus memory)"
  echo "  help                Show this help"
  echo ""
  echo "Build Options:"
  echo "  --keep-builder      Don't remove builder after build (faster rebuilds)"
  echo ""
  echo "Builder Config (current):"
  echo "  CPUs:    $BUILDER_CPUS"
  echo "  Memory:  $BUILDER_MEMORY"
  echo "  Auto-remove after build: yes (use --keep-builder to prevent)"
  echo ""
  echo "Mounted:"
  echo "  $WORKSPACE_DIR -> /workspace"
  echo "  $SHARE_TMP -> /share-tmp"
  echo ""
  echo "Note: Docker socket mounting not supported (use host Docker CLI)"
  echo ""
  echo "Ports:"
  echo "  10000-19999 (mapped 1:1)"
  echo ""
  echo "Note: SSH/GPG keys are copied on first creation (not mounted)"
}

case "${1:-}" in
  ""|enter)
    cmd_enter
    ;;
  stop)
    cmd_stop
    ;;
  destroy)
    cmd_destroy
    ;;
  status)
    cmd_status
    ;;
  build)
    shift
    cmd_build "$@"
    ;;
  rebuild)
    shift
    cmd_rebuild "$@"
    ;;
  logs)
    cmd_logs
    ;;
  builder-configure)
    shift
    cmd_builder_configure "$@"
    ;;
  help|--help|-h)
    cmd_help
    ;;
  *)
    echo "Unknown command: $1"
    cmd_help
    exit 1
    ;;
esac
